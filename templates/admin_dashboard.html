{% extends "base.html" %}

{% block title %}Admin Dashboard - iCapture{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">
                <i class="fas fa-tachometer-alt"></i> Admin Dashboard
            </h1>
            <p>Manage colleges, participants, and view all uploads</p>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
    
    <div class="nav-tabs">
        <a href="#colleges" class="nav-tab active" onclick="showTab('colleges')">
            <i class="fas fa-university"></i> Colleges
        </a>
        <a href="#participants" class="nav-tab" onclick="showTab('participants')">
            <i class="fas fa-users"></i> Participants
        </a>
        <a href="#files" class="nav-tab" onclick="showTab('files')">
            <i class="fas fa-folder"></i> All Files
        </a>
    </div>
    
    <!-- Colleges Tab -->
    <div id="colleges-tab" class="tab-content active">
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-plus-circle"></i> Add New College
            </h2>
            <form method="POST" action="{{ url_for('add_college') }}">
                <div class="form-group">
                    <label for="college-name">
                        <i class="fas fa-university"></i> College Name
                    </label>
                    <input type="text" id="college-name" name="name" required 
                           placeholder="Enter college name">
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-plus"></i> Add College
                </button>
            </form>
        </div>
        
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-list"></i> All Colleges
            </h2>
            {% if colleges %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>College Name</th>
                                <th>Participants</th>
                                <th>Created Date</th>
                                <th style="width:90px;text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for college in colleges %}
                            <tr class="hover-row">
                                <td>{{ college.id }}</td>
                                <td>{{ college.name }}</td>
                                <td>{{ college.participants|length }}</td>
                                <td>{{ college.created_at.strftime('%Y-%m-%d') }}</td>
                                <td class="actions-cell">
                                    <button class="icon-btn edit" title="Edit" onclick="openEditCollege({{ college.id }}, '{{ college.name|e }}')"><i class="fas fa-edit"></i></button>
                                    <button class="icon-btn delete" title="Delete" onclick="confirmDeleteCollege({{ college.id }})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-university"></i>
                    <h3>No Colleges Found</h3>
                    <p>Add your first college to get started</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Participants Tab -->
    <div id="participants-tab" class="tab-content">
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-user-plus"></i> Add New Participant
            </h2>
            <form method="POST" action="{{ url_for('add_participant') }}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="participant-id">
                            <i class="fas fa-id-card"></i> Participant ID
                        </label>
                        <input type="text" id="participant-id" name="participant_id" required 
                               placeholder="Enter participant ID">
                    </div>
                    <div class="form-group">
                        <label for="participant-name">
                            <i class="fas fa-user"></i> Full Name
                        </label>
                        <input type="text" id="participant-name" name="name" required 
                               placeholder="Enter full name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="participant-phone">
                            <i class="fas fa-phone"></i> Phone Number
                        </label>
                        <input type="tel" id="participant-phone" name="phone" required 
                               placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label for="college-select">
                            <i class="fas fa-university"></i> College
                        </label>
                        <select id="college-select" name="college_id" required>
                            <option value="">Select College</option>
                            {% for college in colleges %}
                            <option value="{{ college.id }}">{{ college.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-plus"></i> Add Participant
                </button>
            </form>
        </div>
        
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-users"></i> All Participants
            </h2>
            {% if participants %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Participant ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>College</th>
                                <th>Uploads</th>
                                <th>Created Date</th>
                                <th style="width:90px;text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                            <tr class="hover-row">
                                <td>{{ loop.index }}</td>
                                <td>{{ participant.participant_id }}</td>
                                <td>{{ participant.name }}</td>
                                <td>{{ participant.phone }}</td>
                                <td>{{ participant.college.name }}</td>
                                <td>{{ participant.uploads|length }}</td>
                                <td>{{ participant.created_at.strftime('%Y-%m-%d') }}</td>
                                <td class="actions-cell">
                                    <button class="icon-btn edit" title="Edit" onclick="openEditParticipant({{ participant.id }}, '{{ participant.name|e }}', '{{ participant.phone|e }}', {{ participant.college_id }}, '{{ participant.participant_id|e }}')"><i class="fas fa-edit"></i></button>
                                    <button class="icon-btn delete" title="Delete" onclick="confirmDeleteParticipant({{ participant.id }})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h3>No Participants Found</h3>
                    <p>Add participants to start collecting uploads</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Files Tab -->
    <div id="files-tab" class="tab-content">
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-folder-open"></i> All Participant Files
            </h2>
            <p>Click on a participant to view their uploaded files</p>
            
            {% if participants %}
                <div class="participants-grid">
                    {% for participant in participants %}
                    <div class="participant-card" onclick="viewParticipantFiles({{ participant.id }})">
                        <div class="participant-info">
                            <h3>{{ participant.name }}</h3>
                            <p><i class="fas fa-id-card"></i> {{ participant.participant_id }}</p>
                            <p><i class="fas fa-university"></i> {{ participant.college.name }}</p>
                            <p><i class="fas fa-phone"></i> {{ participant.phone }}</p>
                        </div>
                        <div class="upload-count">
                            <i class="fas fa-upload"></i>
                            <span>{{ participant.uploads|length }} files</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Participants Found</h3>
                    <p>Add participants to view their files</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeInUp 0.5s ease-out;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state i {
    font-size: 3rem;
    color: #ccc;
    margin-bottom: 20px;
    display: block;
}

.empty-state h3 {
    color: #333;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.actions-cell {
    text-align: center;
}

.icon-btn {
    background: transparent;
    border: none;
    padding: 6px 8px;
    border-radius: 8px;
    color: #888;
    margin: 0 4px;
    cursor: pointer;
    opacity: 1; /* always visible */
    transition: all 0.2s ease;
}

.icon-btn.edit:hover {
    color: #3b82f6;
    background: rgba(59,130,246,0.08);
}

.icon-btn.delete:hover {
    color: #ef4444;
    background: rgba(239,68,68,0.08);
}

.participants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.participant-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.participant-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    border-color: #667eea;
}

.participant-info h3 {
    color: #333;
    font-size: 1.2rem;
    margin-bottom: 10px;
    font-weight: 600;
}

.participant-info p {
    color: #666;
    margin: 5px 0;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.participant-info i {
    color: #667eea;
    width: 16px;
}

.upload-count {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
    text-align: center;
    color: #667eea;
    font-weight: 600;
}

.upload-count i {
    margin-right: 8px;
}

@media (max-width: 768px) {
    .participants-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all nav tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked nav tab
    event.target.classList.add('active');

    // Persist active tab
    localStorage.setItem('adminActiveTab', tabName);
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.replaceState({}, '', url);
}

function viewParticipantFiles(participantId) {
    window.location.href = `/admin/files/${participantId}`;
}

// Restore active tab on load (from URL ?tab= or localStorage)
document.addEventListener('DOMContentLoaded', () => {
    const urlTab = new URL(window.location).searchParams.get('tab');
    const saved = localStorage.getItem('adminActiveTab');
    const tabToShow = urlTab || saved || 'colleges';
    // Trigger the correct tab
    document.querySelectorAll('.nav-tab').forEach(link => {
        const href = link.getAttribute('href');
        if (href === '#' + tabToShow) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    const tabEl = document.getElementById(tabToShow + '-tab');
    if (tabEl) tabEl.classList.add('active');
});

// Icon buttons hover visibility
document.addEventListener('mouseover', (e) => {
    const row = e.target.closest('.hover-row');
    if (row) row.classList.add('hovering');
});
document.addEventListener('mouseout', (e) => {
    const row = e.target.closest('.hover-row');
    if (row) row.classList.remove('hovering');
});

async function confirmDeleteParticipant(id) {
    if (!confirm('Delete this participant? This will remove uploads as well.')) return;
    const res = await fetch(`/admin/participants/${id}/delete`, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
        location.href = window.location.pathname + '?tab=participants';
    } else {
        alert(data.message || 'Delete failed');
    }
}

async function confirmDeleteCollege(id) {
    if (!confirm('Delete this college?')) return;
    const res = await fetch(`/admin/colleges/${id}/delete`, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
        location.href = window.location.pathname + '?tab=colleges';
    } else {
        alert(data.message || 'Delete failed');
    }
}

function openEditParticipant(id, name, phone, collegeId, currentPid) {
    const newName = prompt('Edit participant name:', name);
    if (newName === null) return;
    const newPhone = prompt('Edit phone:', phone);
    if (newPhone === null) return;
    const newPid = prompt('Edit participant ID:', currentPid);
    if (newPid === null) return;
    // College is fixed; do not allow editing or send any change
    fetch(`/admin/participants/${id}/edit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName, phone: newPhone, participant_id: newPid })
    }).then(r => r.json()).then(d => {
        if (d.success) {
            location.href = window.location.pathname + '?tab=participants';
        } else {
            alert(d.message || 'Update failed');
        }
    });
}

function openEditCollege(id, name) {
    const newName = prompt('Edit college name:', name);
    if (newName === null) return;
    fetch(`/admin/colleges/${id}/edit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
    }).then(r => r.json()).then(d => {
        if (d.success) {
            location.href = window.location.pathname + '?tab=colleges';
        } else {
            alert(d.message || 'Update failed');
        }
    });
}
</script>
{% endblock %}
